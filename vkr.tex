% !TEX TS-program = xelatex
% !BIB program = bibtex
% !TeX spellcheck = ru_RU

% About magic macroses see also
% https://tex.stackexchange.com/questions/78101/

\input{header.tex}
\input{header2.tex}

\usepackage{totcount}

\usepackage{caption}
\usepackage{listings}
%\usepackage{fancyvrb}
\usepackage{fontawesome5}

\DeclareCaptionFont{white}{ \color{white} }
\DeclareCaptionFormat{listing}{
    \parbox{\textwidth}{\hspace{15pt}#1#2#3}
}
\captionsetup[lstlisting]{ format=listing
  %, labelfont=white, textfont=white
  , singlelinecheck=false, margin=0pt, font={bf}
}

\begin{document}
\input{title.tex}
\maketitle
\setcounter{tocdepth}{2}
\tableofcontents

% \begin{abstract}
%   В курсаче не нужен
% \end{abstract}

\section*{Введение} %мне к новому году обязательно все
\input{000intro} %\today

\section{Постановка задачи} %обяз
\input{010task}

\section{Обзор} %обяз
\input{020related}

% \section{Используемые инструменты}
% \input{instruments.tex}

% \section{Background (опционально)}
% Здесь пишется некоторая дополнительная информация о том, зачем делается то, что делается.

% Например, в работе придумывается какой-то новый метод решения формул в \SMT{} в теориях с числами. Без каких-то дополнительных пояснений будет казаться, что работа состоит из жестокого ``матана'' и совсем не по теме кафедры системного программирования. 
% Поэтому, в данном разделе стоит рассказать, что все эти методы примеряются для верификации в проекте \vsharp{}, и поэтому непосредственно связаны с тематикой кафедры.


%\section{Метод}
%\input{040method}


% \section{Эксперимент (желательно к Новому году)}
% \input{070experiment}

% \section{Применение (того, что сделано на практике)}

% Если применение в лоб не работает, потому что всё изложено чуть более сжато и теоретично, надо рассказать тонкости и правильный метод применения результатов. Если результаты применяются без дополнительных телодвижений, то про это можно не писать.

% \section{Угрозы нарушения корректности (опциональный)}

% Если основная заслуга метода, это то, что он дает лучшие цифры, то стоит сказать, где мы могли облажаться, когда
% \begin{enumerate}
% \item проводили численные замеры;
% \item выбирали тестовый набор (см. \emph{confirmation bias})
% \end{enumerate} 




\section{Реализация}
\subsection{Реализация поиска расписания, соответствующего требованиям}
Вся сложность реализации данного пункта заключается в том, что нужно сделать поиск расписания максимально быстрым, для этого нужно оптимальным способом закодировать в miniKanren поставленные ограничения.
\begin{itemize}
    \item Учет всех предметов из учебного плана
   % \item Не более 6 пар в день
    \item Проверка аудиторий
\end{itemize}
\subsubsection{Учет всех предметов из учебного плана}
Особенностью miniKanren является то, что при составлении запроса важен порядок конъюнктов.
Таким образом, нужно понять, при каком порядке запрос будет завершен быстрее всего. Так как поиск происходит в ширину, то нужно дать возможность программе понять, на каком моменте нужно "обломить" ветку.

\textbf{Важные частные случаи:}
\begin{enumerate}
    \item Обычно группы более "заняты", чем преподаватели, то есть вероятность зайти в тупиковую ветвь быстрее через группу выше. Поэтому конъюнкт, который отвечает за вставку предмета в группу, ставится раньше, чем конъюнкт, отвечающий за преподавателя
    \item При составлении расписания пытаются если задействовать аудиторию, то сделать это по максимуму, поэтому стоит конъюнкт с вставкой предмета ставить спереди преподавателя. 
  % \textbf{Пример вставки предмета с помощью унификации} 
   \begin{lstlisting}[caption=Использование унификации для вставки 4 пары, language=OCaml, frame=single]
    (define (sched subj teachersched schedgroup
     schedclass)
    (fresh (a1 a2 b1 b2 c1 c2)
    (== teachersched `(,a1 . ,a2)) (== a2 subj)
    (== schedgroup `(,b1 . ,b2)) (== b2 subj)
    (== schedclass `(,c1 . c2)) (== c2 subj)))
\end{lstlisting}
    Данная реляция завершается успешно, если получается выполнить все три действия, в противном случае она завершается неуспешно и вызывается другая реляция, которое делает то же самое, просто пытается вставить предмет на другую пару или день.
\end{enumerate}

% \subsubsection{Не более 6 пар в день}
% Данное ограничение решается сразу с помощью двух приемов 
% \begin{itemize}
%     \item Линии conde, которые отвечают за 6 пары, стоят в самом конце, что означает, что предмет вставлен будет на 6 пару только тогда, когда иного варианта нет. Но если окажется, что при вставке 6 пары день будет забит полностью, то сработает реляция, которая показана в следующем пункте
%     \item Реляция =/=, входящая в ядро faster-minikanren. 
%     \begin{lstlisting}[caption=Использование \neq, language=Racket, frame=single]
%     (define (checkfivesubj schedgroup)
%     (fresh (a1 a2 a3 a4 a5 a6)
%     (=/= schedgroup `(,a1,a2,a3,a4,a5,a6))))
% (checkfivesubj schedgroup)
%     \end{lstlisting}
%     Был испробован вариант с использованием реляции lenghto, которая связывает список и длину списка, но данная реляция замедляет код.
% \end{itemize}

\subsubsection{Проверка аудиторий}
За каждой аудиторией закреплено множество предметов, которые могут в ней проводится.
На каждом этапе, когда нужно поставить предмет в расписание, мы должны взять аудиторию, которая подходит для этого. \\
Наиболее удобной реляцией для проверки возможности проведения предмета является $member^o$, которая проверяет, является ли частью списка некоторый элемент, в нашем случае она проверяет, входит ли предмет в список предметов проводимых в аудитории.


\subsection{Дополнительные возможности}

   \subsubsection{Мнение преподавателя} По желанию преподавателя можно освобождать ему определенную пару или день. Время работы программы зачастую почти не меняется, при освобождении или занятии пары, но в некоторых ситуациях эти изменения могут сильно повлиять время ответа, причем в любую сторону.
   
   Реализована данная возможность с помощью реляции унификации: Взяв определенный день или пару расписания, унифицируем переменную, отвечающую за этот день или пару, с пустым списком.
   
   \subsubsection{Освободить определенное время}. Возможность освободить определенные пары у группы. Реализовано аналогично предыдущему пункту.
   \subsubsection{Кучность} Возможность "сдвигать" пары относительно дней недели или номера пар. То есть сдвигать пары в сторону понедельника или в сторону 2-4 пары. 
 %  \includegraphics[width=0,5\textwidth]{condeline.png}
   Специально для этой возможности было написано 20 различных линий conde, где каждая линия отвечает за вставку предмета в определенный день и пару. При изменении порядка линий conde, будет меняться "сдвиг" предметов в пределах недели.
  \begin{lstlisting}[caption=Сдвиг пар, language=OCaml, frame=single]
[(ins2 subj a1 b1 c1 namegroup teachername classnumber)]
[(ins2 subj a2 b2 c2 namegroup teachername classnumber)]
[(ins2 subj a3 b3 c3 namegroup teachername classnumber)]
[(ins2 subj a4 b4 c4 namegroup teachername classnumber)]
[(ins2 subj a5 b5 c5 namegroup teachername classnumber)]
\end{lstlisting}
Представлено 5 линий conde, каждая из которых отвечает за вставку второй пары в определенный день, меняя их местами кучность будет меняться.




% \subsection{Дальнейшие улучшения}
% Добавление следующих ограничений включает в себя погружение в потроха minikanren. 

% \subsubsection{Отсутствие окон}
% Пока не реализовано решение для провеки на окна, используется следующий способ для минимизации окон для первого курса: так как поиск расписания происходит в ширину, то, вызвав в первую очередь составление расписания для первых курсов, там самым мы гарантируем кучность пар для них. 
% \subsubsection{Одинокая пара}
% В данном случае сложно прогнозировать поведение miniKanrena, поэтому есть вероятность постановки одинокой пары, но, чаще всего, это происходит не более раза.
% \subsection{Дополнительные возможности}
% \begin{itemize}
%     \item По желанию преподавателя можно или оставлять свободной какую-либо пару или день, или гарантированно вставить в нее занятие.
%     \item Возможность занять определенные пары у группы или освободить
%     \item Возможность "сдвигать" пары относительно дней недели или номера пар. То есть сдвигать пары в сторону понедельника или в сторону 2-4 пары. 
% \end{itemize}
\subsection{Визуализация}
Визуализация реализована с помощью библиотеки ``simple-xlsx''~\cite{symple}
\includegraphics[width=1\textwidth]{sched.png}

% \subsection{Дополнительные возможности}
% \begin{itemize}
%     \item По желанию преподавателя можно или оставлять свободной какую-либо пару или день, или гарантированно вставить в нее занятие.
%     \item Возможность занять определенные пары у группы или освободить
%     \item Возможность "сдвигать" пары относительно дней недели или номера пар. То есть сдвигать пары в сторону понедельника или в сторону 2-4 пары. 
% \end{itemize}

\section{Замеры производительности}

  
    %здесь создаю табличку с вариантами тестов, с количеством ответов и временем еще можно с одинаковыми данными забить по разному запросы (разделить или соединить)
Замеры проводятся на ноутбуке MacBook Air 13 M1, 8 Gb RAM.\\
Расписание строилось на два потока, в каждом из которых по 4 группы. Учебный план групп был создан на основе плана направления ``Технологии программирования''.

%      \begin{tabbing}
%  \hspace{6em}\= \hspace{12em}\= 
% \hspace{6em}\kill
%  № \> Количество запросов \> Время \\
%  1 \> 2 \> 60 \\
%  2 \> 10 \> 72 \\
%  3 \> 200 \>  90
%     \end{tabbing}

%     \begin{table}
% \caption{Замеры тестов на два потока}
% %\label{tabular}
% %\begin{center}
% \begin{tabular}{ccc}
% № & Количество ответов & время, сек. \\%почему то при объединении не работает вовсе, можно попробовать работать с отдельно вызываемыми функциями
% 1 & 2 & 60\\
% 2 & 10 & 72 \\
% 3 & 200 & 90 \\
% \end{tabular}
% %\end{center}
% \end{table}
 Довольно малое увеличение времени работы алгоритма для получения большего количества расписаний обусловлено тем, что miniKanren использует поиск в ширину. Данный факт можно использовать для получения большого количества расписаний и выбора из них "наиболее удобного".

%\includegraphics[width=0.65\textwidth]{PiSOb_S6Hes.jpeg}

    

    \begin{table}[h]
\caption{Замеры тестов на два потока}
%\label{tabular}
\begin{center}
\begin{tabular}{center}
№ & Количество ответов & время, сек. \\
1 & 2 & 60\\
2 & 10 & 72 \\
3 & 200 & 90 \\
\end{tabular}
\end{center}
\end{table}


 % \textbf{Вывод:} \\При некоторых типах входных данных получение нескольких ответов может быть незатруднительно

    

    
\section{Дальнейшие планы}
   % \begin{enumerate}
   %     \item 
   % \textbf{Имеем:}
   %  \\ Таблица с общим расписанием \\
   %  \textbf{Можно улучшить:}
   %  \\ Таблицы вида преподаватель/нагрузка, преподаватель/аудутория, группа/аудитория, аудитория/нагрузка
   %  \item \textbf{Имеем:} \\ Ручная запись данных в miniKanren \\ %\faCheck
   %  \textbf{Можно улучшить:} \\ Среда для работы с расписанием с помощью записи предметов в таблицы, запись требований в отдельные окна, а не в код %(хочу тут сказать, что можно сделать так, чтобы требования забивали не в код, а по-человечески в таблички всякие)
   %  \item
   %  \textbf{Имеем:}\\Получение нескольких ответов
   %  \\ \textbf{Можно улучшить:}\\ Возможность нахождения решения, удовлетворяющего "неформальным" запросам
   %  \item
   %  \textbf{Ограничения:}      
   %    \begin{enumerate}
   %    \item[\textcolor{blue}{\faCheck}] Полный учет учебного плана
   %        \item[\textcolor{blue}{\faCheck}] Не более 5 пар в день
   %        \item[\textcolor{blue}{\faCheck}]Проверка аудиторий на специализацию и вместимость
   %        \item[\textcolor{orange}{\faExclamation}] Добавить исключение окон
   %        \item [\textcolor{orange}{\faExclamation}]Невозможность поставить только одну пару за день
          
   %    \end{enumerate}      
   %  \end{enumerate}
    %\textbf{План решения дальнейших задач}
    
    Также была проделана работа по составлению плана и оценке сложности некоторых поставленных на следующий семестр задач
    \subsubsection{Отсутствие окон}
    В miniKanren каждой переменной сопоставляется некоторое особое число, называемое id. Каждой паре в расписании занятий соответствует некоторая переменная с уникальным id. При выводе программы можно сразу видеть, что переменная осталась "свежей", то есть она не имеет значение, что в нашем случае значит пустую пару. Но на этапе работы программы не так просто понять, является ли переменная свободной, или нет. Для реализации функции проверки на окна понадобится влезть в тело функции унификации и тд и тп
    \subsubsection{Одинокая пара}
    При решении вышепоставленной задачи решение этой задачи следует почти автоматически.

    Научившись проверять переменные на "пустоту", нам останется написать реляцию, которая, принимая расписание на день недели определенной группы , будет заканчивать провально при единственной непустой переменной, и успешно в остальных случаях.

    Также для двух этих задач важно помнить, что промежуточное решение удовлетворять им не должно, поэтому, помня специфику miniKanren, нужно будет ставить вызов реляций проверки на окна и одинокие пары в конце.
\subsubsection{Оценка расписания}
    Осмысленность данного пункта появляется благодаря поиску в ширину miniKanren, что также можно увидеть и на предыдущем слайде, где большее количество расписаний получается не намного дольше. 
     Как показано в статье ``Методика составления расписания уроков''`\cite{Методика} важно учитывать, в какие дни недели учащиеся более продуктивны, при каких сочетаниях предметов повышается утомляемость и тд и тп.

%\subsubsection{Возможность гарантированно занимать пару}



\section{Результаты}
\textbf{На данный момент выполнены следующие задачи:}
\begin{enumerate}
    \item Разработана процедура поиска расписания, соответствующее следующим требованиям
    \begin{itemize}
        \item Полный учет учебного плана
       % \item Не более 5 пар в день
        \item Проверка аудиторий на специализацию и вместимость
    \end{itemize}
    
    \item Разработано решение ручного визуализирования
\end{enumerate}

 \textbf{Код проекта} доступен в GitHub-репозитории: 
 
 \url{https://github.com/Azatic/Timetablenew}



% \section*{Заключение}
% \input{090conclusion}

\setmonofont[Mapping=tex-text]{CMU Typewriter Text}
  \bibliographystyle{ugost2008ls}
  \bibliography{vkr}
\end{document}
